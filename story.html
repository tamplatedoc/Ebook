<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Cerita</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
    header, footer { text-align: center; padding: 10px; background: #1a1a1a; }
 :root {
  --primary: #ff6b9e;
  --secondary: #a18aff;
  --dark: #1a1a2e;
  --light: #fef6fb;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', system-ui, sans-serif;
}

body {
  background-color: var(--dark);
  color: var(--light);
  min-height: 100vh;
  padding: 1rem;
  display: flex;
  flex-direction: column;
}

.container {
  max-width: 800px;
  margin: auto;
  background: rgba(26, 26, 46, 0.85);
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 0 15px var(--primary);
}

h1 {
  font-size: 2rem;
  text-align: center;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  color: transparent;
  margin-bottom: 0.5rem;
}

.genre {
  text-align: center;
  font-style: italic;
  margin-bottom: 1rem;
}

.story-image {
  display: block;
  width: 100%;
  max-width: 300px;
  margin: 1rem auto;
  border-radius: 12px;
  box-shadow: 0 0 15px var(--primary);
}

.story-content {
  font-size: 1rem;
  text-align: justify;
  margin-bottom: 1.5rem;
}

.controls {
  display: flex;
  justify-content: center;
  gap: 0.8rem;
  flex-wrap: wrap;
  margin-bottom: 1.5rem;
}

.btn {
  padding: 0.6rem 1.2rem;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  border: none;
  border-radius: 50px;
  color: white;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: 0.3s;
  text-align: center;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px var(--primary);
}

.comment-rating {
  margin-top: 1rem;
}

.comment-rating textarea {
  width: 100%;
  padding: 0.5rem;
  margin-bottom: 0.5rem;
  border-radius: 8px;
  border: none;
}

.comment-rating input[type="number"] {
  width: 100px;
  padding: 0.3rem;
  margin-bottom: 0.5rem;
  border-radius: 8px;
  border: none;
}

.comment-item {
  border-bottom: 1px solid #555;
  padding: 0.3rem 0;
}

footer {
  text-align: center;
  font-size: 0.9rem;
  margin-top: auto;
  padding: 1rem 0 0.5rem;
}

footer a {
  color: var(--primary);
  text-decoration: none;
  margin: 0 0.5rem;
}

footer a:hover {
  text-decoration: underline;
}

  </style>
</head>
<body>
  <header>
    <h1 id="judul-cerita">Loading...</h1>
  </header>
  <main>
    <img class="cover" id="gambar-cerita" src="" alt="Cover Cerita">
    <div class="meta" id="meta-info"></div>
    <div class="isi" id="isi-cerita">Sedang memuat isi cerita...</div>

    <section class="rating">
      <h3>‚≠ê Rating</h3>
      <div id="rating-info">Memuat...</div>
      <label for="input-rating">Beri rating (1-5):</label>
      <input type="number" id="input-rating" min="1" max="5">
      <button onclick="submitRating()">Kirim</button>
    </section>

    <section class="komentar">
      <h3>üí¨ Komentar</h3>
      <form onsubmit="submitKomentar(event)">
        <textarea id="input-komentar" rows="3" placeholder="Tulis komentarmu..."></textarea>
        <br>
        <button type="submit">Kirim Komentar</button>
      </form>
      <div class="komentar-list" id="komentar-list"></div>
    </section>
  </main>
  <footer>
    &copy; 2024 Perpustakaan Digital
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
      authDomain: "tamplatedoc.firebaseapp.com",
      databaseURL: "https://tamplatedoc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tamplatedoc",
      storageBucket: "tamplatedoc.appspot.com",
      messagingSenderId: "264966107720",
      appId: "1:264966107720:web:868abe93cdff209040de7d"
    };

    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const realtimeDB = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    if (!id) alert("ID cerita tidak ditemukan di URL");

    async function tampilkanCerita() {
      const doc = await firestore.collection("koleksi").doc(id).get();
      if (!doc.exists) return;
      const data = doc.data();

      document.getElementById("judul-cerita").textContent = data.judul;
      document.getElementById("gambar-cerita").src = data.gambarUrl || "";
      document.getElementById("meta-info").textContent = `${data.genre}`;
      document.getElementById("isi-cerita").textContent = data.isi;

      // update view count
      const viewsRef = realtimeDB.ref(`cerita/${id}/views`);
      viewsRef.transaction(val => (val || 0) + 1);

      // ambil rating
      const ratingRef = realtimeDB.ref(`rating/${id}`);
      ratingRef.once('value', snap => {
        const val = snap.val();
        if (val && val.total && val.jumlah) {
          const avg = (val.total / val.jumlah).toFixed(1);
          document.getElementById("rating-info").textContent = `${avg} dari ${val.jumlah} rating`;
        } else {
          document.getElementById("rating-info").textContent = "Belum ada rating";
        }
      });

      // tampilkan komentar
      realtimeDB.ref(`komentar/${id}`).on('value', snap => {
        const komentarList = document.getElementById("komentar-list");
        komentarList.innerHTML = "";
        const data = snap.val();
        if (data) {
          Object.values(data).forEach(k => {
            const div = document.createElement("div");
            div.className = "komentar-item";
            div.textContent = k.teks || "";
            komentarList.appendChild(div);
          });
        }
      });
    }

    function submitRating() {
      const nilai = parseInt(document.getElementById("input-rating").value);
      if (isNaN(nilai) || nilai < 1 || nilai > 5) return alert("Masukkan rating antara 1 sampai 5");
      const ref = realtimeDB.ref(`rating/${id}`);
      ref.transaction(data => {
        if (data === null) return { total: nilai, jumlah: 1 };
        return { total: (data.total || 0) + nilai, jumlah: (data.jumlah || 0) + 1 };
      });
      alert("Rating berhasil dikirim");
    }

    function submitKomentar(e) {
      e.preventDefault();
      const teks = document.getElementById("input-komentar").value.trim();
      if (!teks) return;
      const ref = realtimeDB.ref(`komentar/${id}`).push();
      ref.set({ teks, waktu: Date.now() });
      document.getElementById("input-komentar").value = "";
    }

    tampilkanCerita();
  </script>
</body>
</html>

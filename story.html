<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Cerita</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
  :root {
    --primary: #ff1744;
    --secondary: #9c27b0;
    --tertiary: #1976d2;
    --light: #ffffff;
    --border-color: #ff5252;
    --border-radius: 12px;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Roboto', sans-serif;
  }

  body {
    background: linear-gradient(to bottom right, var(--primary), var(--secondary), var(--tertiary));
    color: var(--light);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  header {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }

  .title-card {
    width: 100%;
    max-width: 800px;
    background: rgba(26, 26, 46, 0.85);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: 0 0 15px var(--border-color);
    border: 2px solid var(--border-color);
  }

  h1 {
    font-size: 2.5rem;
    background: linear-gradient(to right, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    color: transparent;
    text-align: center;
  }

  .container {
    width: 100%;
    max-width: 800px;
    margin: 0 auto 20px auto;
    background: rgba(26, 26, 46, 0.85);
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: 0 0 15px var(--border-color);
    border: 2px solid var(--border-color);
  }

  .story-image {
    display: block;
    width: 100%;
    max-width: 300px;
    margin: 1rem auto;
    border-radius: var(--border-radius);
    box-shadow: 0 0 15px var(--border-color);
  }

  .story-content {
    font-size: 1.1rem;
    text-align: justify;
    margin-bottom: 1.5rem;
  }

  .genre {
    text-align: center;
    font-style: italic;
    margin: 1rem 0;
    font-size: 1.2rem;
    color: var(--light);
  }

  .rating {
    text-align: center;
    margin: 1.5rem 0;
  }

  .star-rating {
    display: flex;
    justify-content: center;
    cursor: pointer;
  }

  .star {
    font-size: 2rem;
    color: #ffcc00;
    margin: 0 0.1rem;
    transition: color 0.3s;
  }

  .star:hover,
  .star.selected {
    color: #ffcc00;
  }

  .komentar {
    margin-top: 2rem;
  }

  .komentar-list {
    margin-top: 1rem;
    border-top: 1px solid #555;
    padding-top: 1rem;
  }

  .komentar-item {
    border-bottom: 1px solid #555;
    padding: 0.5rem 0;
  }

  footer {
    text-align: center;
    font-size: 0.9rem;
    margin-top: auto;
    padding: 1rem 0;
  }

  footer a {
    color: var(--light);
    text-decoration: none;
    margin: 0 0.5rem;
  }

  footer a:hover {
    text-decoration: underline;
  }

  textarea {
    width: 100%;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: var(--border-radius);
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: var(--light);
  }

  button {
    padding: 0.6rem 1.2rem;
    background: linear-gradient(to right, var(--primary), var(--secondary));
    border: none;
    border-radius: var(--border-radius);
    color: var(--light);
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px var(--border-color);
  }

  .back-button {
    display: inline-block;
    margin: 1rem 0;
    text-align: center;
    text-decoration: none;
    padding: 0.6rem 1.2rem;
    background: var(--primary);
    border-radius: var(--border-radius);
    color: var(--light);
    font-weight: 600;
    transition: 0.3s;
  }

  .back-button:hover {
    background: var(--secondary);
  }

  @media (max-width: 600px) {
    h1 {
      font-size: 1.8rem;
    }

    .title-card,
    .container {
      padding: 1rem;
    }

    .story-content {
      font-size: 1rem;
    }

    .star {
      font-size: 1.5rem;
    }
  }
</style>
</head>
<body>
  <header>
    <h1 id="judul-cerita">Loading...</h1>
  </header>
  <div class="container">
    <img class="story-image" id="gambar-cerita" src="" alt="Cover Cerita">
    <div class="genre" id="meta-info">Genre: Memuat...</div>
    <div class="story-content" id="isi-cerita">Sedang memuat isi cerita...</div>

    <button id="tts-button">Dengarkan Cerita</button>

    <section class="rating">
      <h3>‚≠ê Rating</h3>
      <div id="rating-info">Memuat...</div>
      <div class="star-rating">
        <span class="star" data-value="1">‚òÖ</span>
        <span class="star" data-value="2">‚òÖ</span>
        <span class="star" data-value="3">‚òÖ</span>
        <span class="star" data-value="4">‚òÖ</span>
        <span class="star" data-value="5">‚òÖ</span>
      </div>
    </section>

    <section class="komentar">
      <h3>üí¨ Komentar</h3>
      <form onsubmit="submitKomentar(event)">
        <textarea id="input-komentar" rows="3" placeholder="Tulis komentarmu..."></textarea>
        <button type="submit">Kirim Komentar</button>
      </form>
      <div class="komentar-list" id="komentar-list"></div>
    </section>

    <a href="index.html" class="back-button">Kembali ke Beranda</a>
  </div>
  <footer>
    &copy; 2024 Perpustakaan Digital
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
      authDomain: "tamplatedoc.firebaseapp.com",
      databaseURL: "https://tamplatedoc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tamplatedoc",
      storageBucket: "tamplatedoc.appspot.com",
      messagingSenderId: "264966107720",
      appId: "1:264966107720:web:868abe93cdff209040de7d"
    };

    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const realtimeDB = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    if (!id) alert("ID cerita tidak ditemukan di URL");

    async function tampilkanCerita() {
      const doc = await firestore.collection("koleksi").doc(id).get();
      if (!doc.exists) return;
      const data = doc.data();

      document.getElementById("judul-cerita").textContent = data.judul;
      document.getElementById("gambar-cerita").src = data.gambarUrl || "";
      document.getElementById("meta-info").textContent = `Genre: ${data.genre}`;
      document.getElementById("isi-cerita").textContent = data.isi;

      // update view count
      const viewsRef = realtimeDB.ref(`cerita/${id}/views`);
      viewsRef.transaction(val => (val || 0) + 1);

      // ambil rating
      const ratingRef = realtimeDB.ref(`rating/${id}`);
      ratingRef.once('value', snap => {
        const val = snap.val();
        if (val && val.total && val.jumlah) {
          const avg = (val.total / val.jumlah).toFixed(1);
          document.getElementById("rating-info").textContent = `${avg} dari ${val.jumlah} rating`;
        } else {
          document.getElementById("rating-info").textContent = "Belum ada rating";
        }
      });

      // tampilkan komentar
      realtimeDB.ref(`komentar/${id}`).on('value', snap => {
        const komentarList = document.getElementById("komentar-list");
        komentarList.innerHTML = "";
        const data = snap.val();
        if (data) {
          Object.values(data).forEach(k => {
            const div = document.createElement("div");
            div.className = "komentar-item";
            div.textContent = k.teks || "";
            komentarList.appendChild(div);
          });
        }
      });
    }

    const stars = document.querySelectorAll('.star');

    stars.forEach(star => {
      star.addEventListener('click', () => {
        const rating = star.getAttribute('data-value');
        submitRating(rating);
        highlightStars(rating);
      });
    });

    function highlightStars(rating) {
      stars.forEach(star => {
        star.classList.remove('selected');
        if (star.getAttribute('data-value') <= rating) {
          star.classList.add('selected');
        }
      });
    }

    function submitRating(rating) {
      const nilai = parseInt(rating);
      const ref = realtimeDB.ref(`rating/${id}`);
      ref.transaction(data => {
        if (data === null) return { total: nilai, jumlah: 1 };
        return { total: (data.total || 0) + nilai, jumlah: (data.jumlah || 0) + 1 };
      });
      alert("Rating berhasil dikirim");
    }

    function submitKomentar(e) {
      e.preventDefault();
      const teks = document.getElementById("input-komentar").value.trim();
      if (!teks) return;
      const ref = realtimeDB.ref(`komentar/${id}`).push();
      ref.set({ teks, waktu: Date.now() });
      document.getElementById("input-komentar").value = "";
    }

    // Fungsi untuk TTS
    document.getElementById("tts-button").addEventListener("click", () => {
      const utterance = new SpeechSynthesisUtterance(document.getElementById("isi-cerita").textContent);
      speechSynthesis.speak(utterance);
    });

    tampilkanCerita();
  </script>
</body>
</html>

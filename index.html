<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog Cerita | AMDF.GROUP</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
      authDomain: "tamplatedoc.firebaseapp.com",
      databaseURL: "https://tamplatedoc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tamplatedoc",
      storageBucket: "tamplatedoc.firebasestorage.app",
      messagingSenderId: "264966107720",
      appId: "1:264966107720:web:da19f6109e71390740de7d",
      measurementId: "G-PFK8VQBFCV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const firestore = getFirestore(app);
    const storage = getStorage(app);

    async function loadStories() {
      const container = document.getElementById("catalog");
      const snapshot = await getDocs(collection(firestore, "cerita"));

      for (const doc of snapshot.docs) {
        const data = doc.data();
        const viewsSnap = await new Promise((resolve) => {
          onValue(dbRef(db, `view/${doc.id}`), (snap) => {
            resolve(snap.exists() ? snap.val() : 0);
          }, { onlyOnce: true });
        });

        const ratingsSnap = await new Promise((resolve) => {
          onValue(dbRef(db, `rating/${doc.id}`), (snap) => {
            if (!snap.exists()) return resolve(0);
            const ratings = Object.values(snap.val());
            const avg = ratings.reduce((a, b) => a + Number(b), 0) / ratings.length;
            resolve(avg.toFixed(1));
          }, { onlyOnce: true });
        });

        const thumbURL = await getDownloadURL(storageRef(storage, `thumb/${doc.id}.webp`));

        const card = document.createElement("div");
        card.className = "bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 w-full max-w-xs m-2 cursor-pointer transition hover:scale-105";
        card.innerHTML = `
          <img src="${thumbURL}" class="rounded-lg w-full h-40 object-cover" alt="Thumbnail">
          <h3 class="text-lg font-bold mt-2 dark:text-white">${data.judul}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300">${data.penulis}</p>
          <div class="flex justify-between items-center text-sm mt-1 text-gray-500 dark:text-gray-400">
            <span>üëÅ ${viewsSnap}</span>
            <span>‚≠ê ${ratingsSnap}</span>
          </div>
        `;
        card.onclick = () => location.href = `story.html?id=${doc.id}`;
        container.appendChild(card);
      }
    }

    loadStories();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; transition: background 0.3s ease; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 to-white dark:from-gray-900 dark:to-gray-800 min-h-screen text-gray-900 dark:text-white">
  <div class="max-w-4xl mx-auto py-6 px-4">
    <header class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Koleksi Cerita</h1>
      <div>
        <button onclick="document.documentElement.classList.toggle('dark')" class="px-2 py-1 bg-indigo-600 text-white rounded">Mode</button>
        <a href="login.html" class="ml-2 text-indigo-700 dark:text-indigo-300 underline">Login/Daftar</a>
      </div>
    </header>
    <p class="text-sm mb-6">Baca cerita gratis tanpa login. Jika ingin menjadi penulis, silakan login terlebih dahulu.</p>
    <div id="catalog" class="flex flex-wrap justify-center"></div>
    <footer class="mt-10 text-center text-xs text-gray-500 dark:text-gray-400">
      &copy; 2025 AMDF.GROUP &bull; <a href="#about" class="underline">About</a> &bull; <a href="#privacy" class="underline">Privacy</a>
    </footer>
  </div>
</body>
</html>
